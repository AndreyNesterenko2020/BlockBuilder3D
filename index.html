<!DOCTYPE html>

<script>
    ///////////////////////////////////
    //                               //
    //   Made by Andrey Nesterenko   //
    //        BlockBuilder3D         //
    //                               //
    ///////////////////////////////////
</script>

<html>
    <head>
        <title>BlockBuilder3D version </title>
        <script src="js/three.js"></script>
        <script src="js/OrbitControls.js"></script>
        <script src="js/PointerLockControls.js"></script>
        <script src="js/FirstPersonControls.js"></script>
        <script src="js/missing.js"></script>
        <script src="js/ammo.js"></script>
        <script src="js/GLTFLoader.js"></script>
        <style>
          @font-face {
            font-family: BlockBuilder3D;
            src: url("font/BlockBuilder3D.ttf");
          }
        </style>
    </head>
    <body>
    <h1 id="menu" style="height: 100%; width: 100%; position: fixed; top: 0; margin-left: 0px; margin-top: 0px; text-align: center; background-image: url('textures/dirt.png');">
      <br>BLOCK BUILDER 3D
      <input id="1" style="position: fixed; top: 25%; left: 42%;" type="checkbox" checked=true onclick="document.getElementById('2').checked = false; document.getElementById('3').checked = false; document.getElementById('7').checked = false; game.generation.mode = 'simple';"><p style="position: fixed; top: 20.5%; left: 45%;">single layer generation (recommended)</input>
      <input id="2" style="position: fixed; top: 30%; left: 42%;" type="checkbox" onclick="document.getElementById('1').checked = false; document.getElementById('3').checked = false; document.getElementById('6').checked = false; document.getElementById('7').checked = false; game.generation.mode = 'medium';"><p style="position: fixed; top: 25.5%; left: 45%;">double layer generation</input>
      <input id="3" style="position: fixed; top: 35%; left: 42%;" type="checkbox" onclick="document.getElementById('1').checked = false; document.getElementById('2').checked = false; document.getElementById('6').checked = false; document.getElementById('7').checked = false; game.generation.mode = 'complex';"><p style="position: fixed; top: 30.5%; left: 45%;">triple layer generation</p></input>
      <input id="6" style="position: fixed; top: 40%; left: 42%;" type="checkbox" onclick="document.getElementById('1').checked = false; document.getElementById('2').checked = false; document.getElementById('3').checked = false; document.getElementById('7').checked = false; game.generation.mode = 'void';"><p style="position: fixed; top: 35.5%; left: 45%;">void generation</p></input>
      <input id="4" style="position: fixed; top: 55%; left: 42%;" type="checkbox" checked=true onclick="game.generation.trees = !game.generation.trees"><p style="position: fixed; top: 50.5%; left: 45%;">generate trees</p></input>
      <input id="5" style="position: fixed; top: 60%; left: 42%;" type="checkbox" checked=true onclick="game.generation.puddle = !game.generation.puddle"><p style="position: fixed; top: 55.5%; left: 45%;">generate mud puddle</p></input>
      <input id="7" style="position: fixed; top: 45%; left: 42%;" type="checkbox" onclick="document.getElementById('1').checked = false; document.getElementById('2').checked = false; document.getElementById('3').checked = false; document.getElementById('6').checked = false; game.generation.chromebook = !game.generation.chromebook"><p style="position: fixed; top: 40.5%; left: 45%;">chromebook friendly mode (recommended if simple mode runs slow)</p></input>
      <input id="8" style="position: fixed; top: 65%; left: 42%;" type="checkbox" checked=true onclick="game.generation.respawn = !game.generation.respawn"><p style="position: fixed; top: 60.5%; left: 45%;">allow respawn</p></input>
      <button style="background-color: white; position: fixed; top: 70%; left: 48%;" type="checkbox" onclick="Ammo().then(game.init);this.outerHTML=''; document.getElementById('menu').innerHTML = '<br>BLOCK BUILDER 3D<br><br><br><br><br><br><br><br><br>generating world...';"><h1>PLAY</h1></button>
    </h1>
	<img style="pointer-events: none; position: absolute; left: 50%; top: 50%" id="crosshair" src="textures/crosshair.png"></img>
        <script>
            var game = {
                version: "1.3.0",
                materials: {},
                blocks: {},
                blockObjects: {},
                UI: {},
                generation: {mode: "simple", trees: true, puddle: true, chromebook: false, respawn: true},
                controls: {selection: null},
                FOV: 60,
                range: 4,
                physics: {},
                debug: false,
            };
            game.scene = new THREE.Scene();
            game.textureLoader = new THREE.TextureLoader();
            game.raycaster = new THREE.Raycaster;
            game.camera = new THREE.PerspectiveCamera(game.FOV, window.innerWidth / window.innerHeight, 0.1, 1000);
            game.renderer = new THREE.WebGLRenderer();
            game.renderer.setSize(window.innerWidth, window.innerHeight*0.96);
            document.body.appendChild(game.renderer.domElement);
            game.geometry = new THREE.BoxGeometry();
            game.materials.defaultMaterial = new THREE.MeshLambertMaterial({map: game.textureLoader.load(missing)});
            game.scene.background = new THREE.Color(0xffffff);
            game.controls.Orbit = new THREE.OrbitControls(game.camera, game.renderer.domElement);
            game.controls.FirstPerson = new THREE.FirstPersonControls(game.camera, game.renderer.domElement);
            game.controls.PointerLock = new THREE.PointerLockControls(game.camera, game.renderer.domElement);
            game.controls.FirstPerson.movementSpeed = 10;
            game.camera.position.set(8, 8, 8);
            game.Sun = new THREE.DirectionalLight(0xffffff, 1, 1000);
            game.Sun.position.set(5,10,2);
            game.scene.add(game.Sun);
            game.Sun.CastShadow	= true;
            game.renderer.shadowMap.enabled = true;
            game.AmbientLight = new THREE.AmbientLight(0x404040);
            game.scene.add(game.AmbientLight);
            game.clock = new THREE.Clock();
            game.gamemode = 0;
            game.renderer.domElement.onclick = function (){
              if (game.controls.selection == "FreeCam" || game.controls.selection == "Player") {
                game.controls.PointerLock.lock();
              }
            }
            game.render = function (){
                requestAnimationFrame(game.render);
                game.renderer.render(game.scene, game.camera);
                game.camera.fov = game.FOV;
                game.camera.updateProjectionMatrix();
                game.controls.FirstPerson.update(game.clock.getDelta());
                if(game.player) {
                  if(game.FPS < 30){
                    game.UI.lag.style.opacity = 1;
                  } else {
                    game.UI.lag.style.opacity = 0;
                  };
                  if(game.player.health <= 2) {
                    document.getElementById("health").style.width = game.player.health+"%";
                  } else {
                    document.getElementById("health").style.width = game.player.health-2+"%";
                  };
                  document.getElementById("health").innerHTML = game.player.health;
                };
                if(game.controls.selection == "FreeCam"){
                  if(game.controls.PointerLock.isLocked){
                    game.UI.lock.style.opacity = 0;
                  } else {
                    game.UI.lock.style.opacity = 1;
                  };
                  game.controls.FirstPerson.enabled = true;
                  game.controls.PointerLock.enabled = true;
                  document.getElementById("crosshair").style.display = "block";
                } else {
                  game.controls.FirstPerson.enabled = false;
                  game.controls.PointerLock.enabled = false;
                  document.getElementById("crosshair").style.display = "none";
                }
                if(game.controls.selection == "Orbit"){
                  game.controls.Orbit.enabled = true;
                } else {
                  game.controls.Orbit.enabled = false;
                };
                if(game.controls.selection == "Player"){
                  if(game.controls.PointerLock.isLocked){
                    game.UI.lock.style.opacity = 0;
                  } else {
                    game.UI.lock.style.opacity = 1;
                  };
                  game.controls.PointerLock.enabled = true;
                  document.getElementById("crosshair").style.display = "block";
                };
                if(game.UI.debug) {
                  if(game.debug){
                    try {
                      var closestEntity = undefined;
                      var closestDistance = Infinity;
                      for(var i = 1; i <= Object.keys(game.entities).length; i++){
                        if(game.entities[i] == game.player || game.entities[i].health == 0 || game.entities[i][0]){
                          continue;
                        };
                        if(closestDistance > game.entities[i].hitboxCombat.position.distanceTo(game.player.hitboxCombat.position)){
                          closestDistance = game.entities[i].hitboxCombat.position.distanceTo(game.player.hitboxCombat.position);
                          closestEntity = game.entities[i];
                        };
                      };
                      var objects = Object.values(game.blocks);
                      var intersects = game.raycaster.intersectObjects(objects);
                      var block = "";
                      if (intersects.length > 0 && intersects[0].distance <= game.range && !intersects[0].object.entity) {
                        block = intersects[0].object.block.type;
                      };
                      game.UI.debug.innerHTML = "BlockBuilder3D version: "+game.version+"<br>THREE js version: "+THREE.REVISION+"<br><br>FPS: "+game.FPS+"<br><br>Nearest Entity: "+closestEntity.name+"<br>Distance: "+closestDistance+"<br><br>Player position: "+game.player.getPosition().position+"<br><br>Facing block: "+block+"<br>Selected: "+game.UI.selection+"<br><br>Gamemode: "+game.gamemode+"<br><br>Bull angry: "+game.bullAnger+"<br><br>Generation Settings:<br>Mode: "+game.generation.mode+"<br>Size: "+game.generation.size+"<br>Allow respawn: "+game.generation.respawn+"<br>Chromebook mode: "+game.generation.chromebook+"<br>Mud puddle: "+game.generation.puddle+"<br>Generate trees: "+game.generation.trees;
                      game.UI.debug.style.display = "block";
                    } catch (error) {
                      undefined;
                    };
                  } else {
                    game.UI.debug.style.display = "none";
                  }; 
                };
                scrollTo(0,0);
            };
            game.init = function() {
                document.title = document.title + " " + game.version;
                game.render();
                game.UI.init();
                //game.block(0,0,0, "stone");
                game.physics.collisionConfiguration = new Ammo.btDefaultCollisionConfiguration();
                game.physics.dispatcher = new Ammo.btCollisionDispatcher(game.physics.collisionConfiguration);
                game.physics.overlappingPairCache = new Ammo.btDbvtBroadphase();
                game.physics.solver = new Ammo.btSequentialImpulseConstraintSolver();
                game.physics.physicsWorld = new Ammo.btDiscreteDynamicsWorld(game.physics.dispatcher, game.physics.overlappingPairCache, game.physics.solver, game.physics.collisionConfiguration);
                game.physics.physicsWorld.setGravity(new Ammo.btVector3(0, -9.81, 0));
                game.physics.tmpTrans = new Ammo.btTransform();
                game.generation.generate();
                game.entityPhysics();
                game.startFPS();
            };
            game.FPS = 0;
            game.startFPS = function() {
              let be = Date.now();
              requestAnimationFrame(function loop(){
                let now = Date.now();
                game.FPS = Math.round(1000 / (now - be));
                be = now;
                requestAnimationFrame(loop);
              });
            };
            window.addEventListener('resize', function (){
                game.camera.aspect = window.innerWidth / window.innerHeight;
                game.renderer.setSize( window.innerWidth, window.innerHeight );
            });
            window.onload = function (){
                console.log("BlockBuilder3D "+game.version+" running on "+navigator.platform)
            };
        </script>
        <script src="js/block.js"></script>
        <script src="js/UI.js"></script>
        <script src="js/worldgen.js"></script>
        <script src="js/entity.js"></script>
        <script src="js/entityTypes.js"></script>
        <script src="js/blockTypes.js"></script>
    </body>
</html>
